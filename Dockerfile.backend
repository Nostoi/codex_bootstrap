# Backend Dockerfile for Codex Bootstrap
FROM node:20-alpine
WORKDIR /app

# Install OpenSSL and other dependencies
RUN apk add --no-cache openssl bash

# Install dependencies
COPY backend/package*.json ./
RUN npm install

# Copy source files to current directory
COPY backend/ ./

# Generate Prisma client
RUN npx prisma generate

# Install wait-for-it for database readiness
ADD https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh /wait-for-it.sh
RUN chmod +x /wait-for-it.sh

# Build the application
RUN npm run build

# Set NODE_PATH to ensure module resolution works correctly
ENV NODE_PATH=/app/node_modules

# Add health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000

# Production command with proper migrations and feature flags support
CMD ["/wait-for-it.sh", "db:5432", "--timeout=30", "--", "sh", "-c", "npx prisma migrate deploy && npm run start:prod"]
